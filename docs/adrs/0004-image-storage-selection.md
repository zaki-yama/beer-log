# 4. 画像ストレージの選択

Date: 2024-03-26

## ステータス

提案

## 文脈

- ビールの写真を保存・管理する必要がある
- スマートフォンで撮影した画像をアップロード
- 画像の最適化（リサイズ、圧縮）が必要
- 将来的なAWSへの移行を考慮

## 検討された選択肢

### 1. Cloudinary

#### 長所
- 画像の最適化・変換が優れている
- CDN機能が組み込み済み
- 無料枠が比較的寛容
  - 25クレジット/月（約25万回の変換に相当）
    - 1回の画像アップロードで1クレジット消費
    - 画像の変換（リサイズなど）で0.001〜0.002クレジット消費
    - 例：1枚の画像をアップロードし、2サイズに変換する場合 ≒ 1.004クレジット
  - ストレージ容量：25GB
  - 月間帯域幅：25GB
- URLベースでの画像変換（リサイズ、フォーマット変更など）
- 実装が容易

#### 短所
- 無料枠を超えた場合のコストが高め
- ベンダーロックインの可能性
- データの地理的制限に関する柔軟性が低い

### 2. Supabase Storage

#### 長所
- データベース（Supabase）と同じプラットフォーム
- S3互換のAPI
- 認証・認可との統合が容易
- 無料枠あり（5GBまで）
- バケットによる整理が可能

#### 短所
- 画像最適化機能が限定的
- CDN機能が基本的
- AWS S3と比べて機能が限定的

### 3. Amazon S3 + CloudFront

#### 長所
- 高い信頼性とスケーラビリティ
- グローバルなCDNネットワーク
- 詳細なアクセス制御
- Lambda@Edgeによる画像最適化が可能
- コスト効率が良い（利用量に応じた課金）

#### 短所
- 初期設定が複雑
- 画像最適化には追加の実装が必要
- CloudFrontの設定が必要

## 決定

現時点では **Cloudinary** を推奨しますが、以下の条件下では **Amazon S3 + CloudFront** への移行を検討します：

1. アプリケーション全体をAWSに移行する際
2. 画像の処理量が大幅に増加し、コスト最適化が必要になった場合
3. 特定地域でのデータ保管要件が発生した場合

理由（Cloudinaryを選択する理由）：
1. 開発初期段階での実装の容易さ
2. 画像最適化機能の充実
3. CDN機能の組み込み
4. 無料枠での開発・検証が可能

## 影響

### 良い影響
- 画像最適化の実装コストを削減
- CDNによる高速な画像配信
- 開発効率の向上

### 考慮すべき点
- **Amazon S3への移行を見据えた設計**
  - 画像のメタデータはデータベースで管理
  - 画像URLの構造を抽象化
  - 環境変数による設定管理
- 画像の命名規則とパス構造の標準化
- バックアップ戦略の検討
- CORS設定の適切な管理 
