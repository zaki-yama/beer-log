# 2. ホスティングプラットフォームの選択

Date: 2024-03-26
Modified: 2024-03-27

## ステータス

承認

## 文脈

- Next.jsアプリケーションをホスティングするプラットフォームを選定する必要がある
- 開発効率とコストのバランスを考慮する必要がある
- 将来的なスケーリングの可能性も考慮する

## 検討された選択肢

### 1. Cloudflare Pages

#### 長所
- Next.jsのサポート（Pages Functions経由でのAPI Routes対応）
- エッジでの実行による高速なレスポンス
- GitHubとの優れた連携による自動デプロイ
- 無料枠が寛容（1アカウントあたり500ビルド/月、無制限の帯域幅）
- CDN、SSL証明書が標準搭載
- デプロイが簡単で開発者体験が良い
- Cloudflareの他のサービス（Workers, R2等）との統合が容易

#### 短所
- Next.jsのApp Router機能の一部に制限がある可能性
- ビルド時間に制限がある（最大20分）
- Node.jsのバージョン選択に制限がある

### 2. Vercel

#### 長所
- Next.jsの開発元による公式プラットフォーム
- エッジでの実行による高速なレスポンス
- GitHubとの優れた連携による自動デプロイ
- 優れたダッシュボード・モニタリング機能
- Next.jsの最新機能への迅速な対応

#### 短所
- 無料枠の制限が厳しい
- サーバーレス関数の実行時間制限が厳しい
- 商用利用時のコストが比較的高い

### 3. Fly.io

#### 長所
- Next.jsのホスティングに対応（Dockerベース）
- グローバルエッジデプロイメントが可能
- 無料枠が比較的寛容
- DockerベースでカスタマイズしやすいI
- Node.jsアプリケーションの実行に最適化されている
- App Router機能を含むNext.jsの全機能が利用可能
- WebSocketなどの高度な機能もサポート

#### 短所
- 料金体系がやや複雑
- AWS/GCPと比べると知見が少ない
- デプロイの設定がVercelやCloudflare Pagesと比べてやや複雑

### 4. AWS

#### 長所
- 豊富なサービスと柔軟なインフラ構成
- 高い信頼性とスケーラビリティ
- 詳細なモニタリングと運用ツール
- 大規模なコミュニティと豊富な知見
- セキュリティ機能が充実

具体的な構成案：
- ECS（Fargate）でのコンテナ実行
- Application Load Balancerによる負荷分散
- Route 53でのDNS管理
- CloudFrontによるCDN
- AWS WAFによるセキュリティ対策

#### 短所
- 初期構築のコストと手間が大きい
- 料金の見積もりが複雑
- インフラ管理の知識が必要
- 小規模アプリケーションではオーバースペック

## 決定

現時点では **Cloudflare Pages** を採用します。以下の条件下では他のプラットフォームへの移行を検討します：

1. Next.jsのApp Router機能で対応できない制限が発生した場合
2. より高度なカスタマイズが必要になった場合
3. ビルド時間の制限が問題になった場合

理由：
1. 無料枠が寛容で、開発・検証に適している
2. デプロイが簡単で、開発者体験が優れている
3. CDNが標準搭載されており、グローバルでの高速なレスポンスが期待できる
4. GitHubとの連携による自動デプロイが容易
5. Cloudflareの他のサービスとの統合が容易

## 影響

### 良い影響
- エッジでの実行による高速なレスポンス
- デプロイの自動化が容易
- インフラ管理の負担が少ない
- コスト面での予測が容易

### 考慮すべき点
- Next.jsのApp Router機能の制限事項の把握と対応
- 将来的な機能要件の変更に応じて、他プラットフォームへの移行パスを確保
  - プラットフォーム固有の機能への依存を最小限に
  - 環境変数による設定の外部化
  - コンテナ化を考慮したアプリケーション設計
